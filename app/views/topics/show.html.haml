- content_for(:page_title, @topic.title)
- @topic = @topic.decorate

%section#topic
  %section.block
    .title
      %h2= @topic.title
    %ul.tags= @topic.tags
    .score= @topic.score

  .messages
    %section.block.message
      %aside.left
        = @topic.author.avatar(60)

      %aside.top
        %span.author= @topic.author.name

        %date{ datetime: @topic.created_at.to_time.iso8601, title: l(@topic.created_at) }
          il y a
          = time_ago_in_words(@topic.created_at)

        .score{ class: @topic.score > 0 ? "score_positive" : "" }
          %span.count= @topic.score
          - if can?(:score, @topic)
            - voted = @topic.score_value == Score::POSITIVE
            = link_to raw('<i class="icon-chevron-up"></i>'), score_topic_path(@topic, vote: voted ? 'neutral' : 'positive'), method: :post, class: [ 'score_positive', voted && 'selected' ]
            - voted = @topic.score_value == Score::NEGATIVE
            = link_to raw('<i class="icon-chevron-down"></i>'), score_topic_path(@topic, vote: voted ? 'neutral' : 'negative'), method: :post, class: [ 'score_negative', voted && 'selected' ]

      .body
        = prettify_message(@topic.content)

      %aside.bottom
        - if can?(:update, @topic)
          = link_to(raw('<i class="icon-edit"></i> Éditer'), edit_topic_path(@topic), class: 'edit_reply')

    - @replies.decorate.each do |reply|
      %section.block.message
        %aside.left
          = reply.author.avatar(60)

        %aside.top
          %span.author= reply.author.name

          %date{ datetime: reply.created_at.to_time.iso8601, title: l(reply.created_at) }
            il y a
            = time_ago_in_words(reply.created_at)

          .score{ class: reply.score > 0 ? "score_positive" : "" }
            %span.count= reply.score
            - if can?(:score, reply)
              - voted = reply.score_value == Score::POSITIVE
              = link_to raw('<i class="icon-chevron-up"></i>'), score_topic_reply_path(@topic, reply, vote: voted ? 'neutral' : 'positive'), method: :post, class: [ 'score_positive', voted && 'selected' ]
              - voted = reply.score_value == Score::NEGATIVE
              = link_to raw('<i class="icon-chevron-down"></i>'), score_topic_reply_path(@topic, reply, vote: voted ? 'neutral' : 'negative'), method: :post, class: [ 'score_negative', voted && 'selected' ]

        .body
          = prettify_message(reply.content)

        %aside.bottom
          - if can?(:update, reply)
            = link_to(raw('<i class="icon-edit"></i> Éditer'), edit_topic_reply_path(@topic, reply), class: 'edit_reply')
          - if can?(:reply, @topic)
            = link_to(raw('<i class="icon-file-alt"></i> Répondre'), "#new_reply", class: 'new_reply')

    - if can?(:reply, @topic)
      .topic-actions-container{ name: 'new_reply' }
        .topic-actions
          = form_for [ @topic, Reply.new ] do |f|
            = f.label :content, "Réponse"
            = f.text_area :content
            %button{ class: 'btn', name: 'cancel' } Annuler
            %button{ class: 'btn', name: 'commit' } Répondre

  %div= paginate(@replies)
